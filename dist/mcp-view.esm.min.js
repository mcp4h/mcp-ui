async function u(r,n,e){try{if(r instanceof Response){if(!r.ok)return{ok:!1,mime:"text/plain",body:new Uint8Array,error:`HTTP ${r.status}`};let t=new Uint8Array(await r.arrayBuffer());return{ok:!0,mime:r.headers.get("content-type")||m(n,e),body:t}}if(r instanceof Blob){let t=new Uint8Array(await r.arrayBuffer());return{ok:!0,mime:r.type||m(n,e),body:t}}if(typeof r=="string"){let o=new TextEncoder().encode(r);return{ok:!0,mime:m(n,e),body:o}}if(r instanceof ArrayBuffer){let t=new Uint8Array(r);return{ok:!0,mime:m(n,e),body:t}}if(r instanceof Uint8Array)return{ok:!0,mime:m(n,e),body:r}}catch(t){return{ok:!1,mime:"text/plain",body:new Uint8Array,error:t instanceof Error?t.message:"Unknown error"}}return{ok:!1,mime:"text/plain",body:new Uint8Array,error:"Unsupported resolver result"}}function m(r,n){if(r==="document")return"text/html";if(r==="style")return"text/css";if(r==="script")return"text/javascript";let e=A(n);if(e){let t={css:"text/css",js:"text/javascript",mjs:"text/javascript",cjs:"text/javascript",json:"application/json",svg:"image/svg+xml",png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",avif:"image/avif",woff:"font/woff",woff2:"font/woff2",ttf:"font/ttf",otf:"font/otf",mp3:"audio/mpeg",wav:"audio/wav",mp4:"video/mp4",webm:"video/webm"};if(t[e])return t[e]}return r==="img"?"image/png":"application/octet-stream"}function A(r){try{let t=new URL(r).pathname.split("/").pop();return!t||!t.includes(".")?null:t.split(".").pop()?.toLowerCase()||null}catch{return null}}function g(r){return`(() => {
  const initialData = ${E(r)};
  window.mcpData = initialData;
  const pending = new Map();
  const toolPending = new Map();
  let nextId = 1;
  let nextToolId = 1;
  const decoder = new TextDecoder();
  const deferredScripts = [];
  let deferredReady = document.readyState !== "loading";
  let deferredListenerAttached = false;

  function sanitizeLayerName(name) {
    if (!name) return null;
    const trimmed = String(name).trim();
    if (!trimmed) return null;
    if (!/^[a-zA-Z0-9_-]+$/.test(trimmed)) return null;
    return trimmed;
  }

  function requestResource(uri, kind) {
    return new Promise((resolve) => {
      const id = nextId++;
      pending.set(id, resolve);
      window.parent.postMessage({ type: "mcp:request", id, uri, kind }, "*");
    });
  }

  function enqueueDeferredScript(run) {
    if (!deferredReady && document.readyState !== "loading") {
      deferredReady = true;
    }
    deferredScripts.push(run);
    if (!deferredReady && !deferredListenerAttached) {
      deferredListenerAttached = true;
      document.addEventListener(
        "DOMContentLoaded",
        () => {
          deferredReady = true;
          flushDeferredScripts();
        },
        { once: true }
      );
    }
    if (deferredReady) {
      flushDeferredScripts();
    }
  }

  function flushDeferredScripts() {
    while (deferredScripts.length) {
      const run = deferredScripts.shift();
      if (typeof run === "function") run();
    }
  }

  function callTool(params) {
    return new Promise((resolve, reject) => {
      const id = nextToolId++;
      toolPending.set(id, { resolve, reject });
      window.parent.postMessage({ type: "mcp:tool-call", id, params }, "*");
    });
  }

  window.addEventListener("message", (event) => {
    if (event.source !== window.parent) return;
    const data = event.data;
    if (!data) return;
    if (data.type === "mcp:response") {
      const resolve = pending.get(data.id);
      if (!resolve) return;
      pending.delete(data.id);
      resolve(data);
      return;
    }
    if (data.type === "mcp:tool-result") {
      const entry = toolPending.get(data.id);
      if (!entry) return;
      toolPending.delete(data.id);
      if (data.ok) {
        entry.resolve(data.result);
      } else {
        const message = data.error || "Tool call failed";
        entry.reject(new Error(message));
      }
      return;
    }
    if (data.type === "mcp-data:update") {
      window.mcpData = data.payload;
      window.dispatchEvent(new CustomEvent("mcp-data", { detail: data.payload }));
    }
  });

  window.mcp = window.mcp || {};
  window.mcp.callTool = callTool;

  function toText(body) {
    const buffer = body || new ArrayBuffer(0);
    return decoder.decode(new Uint8Array(buffer));
  }

  function toBlobUrl(body, mime) {
    const buffer = body || new ArrayBuffer(0);
    const blob = new Blob([buffer], { type: mime || "application/octet-stream" });
    return URL.createObjectURL(blob);
  }

  function copyAttributes(from, to, skip) {
    const skipSet = new Set(skip || []);
    for (const attr of Array.from(from.attributes)) {
      if (skipSet.has(attr.name)) continue;
      to.setAttribute(attr.name, attr.value);
    }
  }

  class McpLink extends HTMLElement {
    connectedCallback() {
      if (this.hasAttribute("data-mcp-blocked")) return;
      const href = this.getAttribute("href");
      if (!href) return;
      const rel = (this.getAttribute("rel") || "").toLowerCase();
      if (rel && rel !== "stylesheet") return;
      requestResource(href, "style").then((res) => {
        if (!res || !res.ok) return;
        const style = document.createElement("style");
        const media = this.getAttribute("media");
        if (media) style.setAttribute("media", media);
        const layer = sanitizeLayerName(this.getAttribute("layer")) || "mcp-content";
        style.textContent = "@layer " + layer + " {\\n" + toText(res.body) + "\\n}";
        if (this.hasAttribute("data-mcp-head")) {
          (document.head || document.documentElement).appendChild(style);
          this.remove();
          return;
        }
        this.replaceWith(style);
      });
    }
  }

  class McpScript extends HTMLElement {
    connectedCallback() {
      if (this.hasAttribute("data-mcp-blocked")) {
        console.error("[mcp] script blocked", this.getAttribute("src"));
        return;
      }
      const src = this.getAttribute("src");
      if (!src) {
        console.error("[mcp] script missing src", this);
        return;
      }
      const isDefer = this.hasAttribute("defer");
      requestResource(src, "script").then((res) => {
        if (!res || !res.ok) {
          console.error("[mcp] script resolve failed", src, res?.error || "unknown");
          return;
        }
        const script = document.createElement("script");
        const type = this.getAttribute("type");
        if (type) script.setAttribute("type", type);
        script.textContent = toText(res.body);
        console.debug("[mcp] script injected", src);
        const placeScript = () => {
          if (this.hasAttribute("data-mcp-head")) {
            (document.head || document.documentElement).appendChild(script);
            this.remove();
            return;
          }
          this.replaceWith(script);
        };
        if (isDefer) {
          enqueueDeferredScript(placeScript);
          return;
        }
        placeScript();
      });
    }
  }

  class McpImg extends HTMLElement {
    connectedCallback() {
      if (this.hasAttribute("data-mcp-blocked")) return;
      const src = this.getAttribute("src");
      if (!src) return;
      requestResource(src, "img").then((res) => {
        if (!res || !res.ok) return;
        const img = document.createElement("img");
        copyAttributes(this, img, ["src"]);
        const url = toBlobUrl(res.body, res.mime);
        img.addEventListener("load", () => URL.revokeObjectURL(url), { once: true });
        img.addEventListener("error", () => URL.revokeObjectURL(url), { once: true });
        img.setAttribute("src", url);
        this.replaceWith(img);
      });
    }
  }

  class McpMedia extends HTMLElement {
    connectedCallback() {
      if (this.hasAttribute("data-mcp-blocked")) return;
      const src = this.getAttribute("src");
      if (!src) return;
      const tag = this.tagName.toLowerCase().replace("mcp-", "");
      requestResource(src, "media").then((res) => {
        if (!res || !res.ok) return;
        const node = document.createElement(tag);
        copyAttributes(this, node, ["src"]);
        const url = toBlobUrl(res.body, res.mime);
        if (tag === "source") {
          node.setAttribute("src", url);
        } else {
          node.setAttribute("src", url);
          node.addEventListener("loadeddata", () => URL.revokeObjectURL(url), { once: true });
          node.addEventListener("error", () => URL.revokeObjectURL(url), { once: true });
        }
        this.replaceWith(node);
      });
    }
  }

  class McpAudio extends McpMedia {}
  class McpVideo extends McpMedia {}
  class McpSource extends McpMedia {}

  customElements.define("mcp-link", McpLink);
  customElements.define("mcp-script", McpScript);
  customElements.define("mcp-img", McpImg);
  customElements.define("mcp-audio", McpAudio);
  customElements.define("mcp-video", McpVideo);
  customElements.define("mcp-source", McpSource);
})();`}function E(r){try{return JSON.stringify(r??null).replace(/</g,"\\u003c").replace(/>/g,"\\u003e").replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")}catch{return"null"}}var M="data-mcp-blocked";function b(r){let e=new DOMParser().parseFromString(r.html,"text/html");h(e.documentElement,"mcp-root"),e.body&&h(e.body,"mcp-root"),d(e,"link","href","mcp-link",r),d(e,"script","src","mcp-script",r),d(e,"img","src","mcp-img",r),d(e,"source","src","mcp-source",r),d(e,"audio","src","mcp-audio",r),d(e,"video","src","mcp-video",r);let t=C(e),o=e.createElement("style");o.setAttribute("data-mcp","theme"),o.textContent=r.themeCss,t.insertBefore(o,t.firstChild);let s=o.nextSibling;if(r.themeLink){let c=L(e,r.themeLink,r);c&&(t.insertBefore(c,o.nextSibling),s=c.nextSibling)}let i=e.createElement("script");return i.setAttribute("data-mcp","bootstrap"),i.textContent=r.bootstrapScript,t.insertBefore(i,s),`${e.doctype?`<!doctype ${e.doctype.name}>`:"<!doctype html>"}
${e.documentElement.outerHTML}`}function d(r,n,e,t,o){let s=Array.from(r.getElementsByTagName(n));for(let i of s){let a=i.getAttribute(e);if(!a)continue;let c=v(a,o.rootUri||void 0);if(!c||c.scheme!=="ui"&&c.scheme!=="http"&&c.scheme!=="https")continue;let l=r.createElement(t);U(i,l),l.setAttribute(e,c.url),i.ownerDocument?.head&&i.ownerDocument.head.contains(i)&&l.setAttribute("data-mcp-head","true"),(c.scheme==="http"||c.scheme==="https")&&(o.allowRemote(c.url)||l.setAttribute(M,"true")),i.replaceWith(l)}}function v(r,n){let e=r.trim();if(!e||e.startsWith("#"))return null;let t=e.match(/^[a-zA-Z][a-zA-Z0-9+.-]*:/);if(t){let o=t[0].slice(0,-1).toLowerCase();return f(o)?null:{url:e,scheme:o}}if(!n)return null;try{let o=new URL(e,n).toString(),s=new URL(o).protocol.replace(":","").toLowerCase();return f(s)?null:{url:o,scheme:s}}catch{return null}}function f(r){return["data","blob","mailto","tel","javascript","about"].includes(r)}function U(r,n){for(let e of Array.from(r.attributes))n.setAttribute(e.name,e.value)}function h(r,n){if(!r)return;let e=r.getAttribute("class");if(!e){r.setAttribute("class",n);return}let t=new Set(e.split(/\s+/).filter(Boolean));t.add(n),r.setAttribute("class",Array.from(t).join(" "))}function C(r){if(r.head)return r.head;let n=r.createElement("head"),e=r.documentElement;return e.firstChild?e.insertBefore(n,e.firstChild):e.appendChild(n),n}function L(r,n,e){let t=n.trim(),o=t.startsWith("ui://")?v(t,e.rootUri||void 0):S(t);if(!o)return null;if(o.scheme==="ui"){let s=r.createElement("mcp-link");return s.setAttribute("rel","stylesheet"),s.setAttribute("href",o.url),s.setAttribute("layer","mcp-user"),s}if(o.scheme==="http"||o.scheme==="https"){let s=r.createElement("link");return s.setAttribute("rel","stylesheet"),s.setAttribute("href",o.url),s.setAttribute("layer","mcp-user"),s}return null}function S(r){if(typeof window>"u"||!window.location)return null;try{let n=new URL(r,window.location.href).toString(),e=new URL(n).protocol.replace(":","").toLowerCase();return f(e)?null:{url:n,scheme:e}}catch{return null}}var y=["mcp-default","mcp-content","mcp-user"],T={"--mcp-color-bg":"#f7f7f5","--mcp-color-fg":"#1f1f1b","--mcp-color-muted":"#e7e6e2","--mcp-color-muted-fg":"#4b4a44","--mcp-color-border":"#d1d0ca","--mcp-color-border-strong":"#b5b3ab","--mcp-surface":"#ffffff","--mcp-surface-alt":"#f0f0ec","--mcp-color-primary":"#3b5ccc","--mcp-color-primary-fg":"#f8f9ff","--mcp-color-secondary":"#5b6478","--mcp-color-secondary-fg":"#f5f7fb","--mcp-color-accent":"#2f7f6b","--mcp-color-accent-fg":"#f1fffb","--mcp-color-success":"#2f7f6b","--mcp-color-success-fg":"#f1fffb","--mcp-color-warning":"#b26a1f","--mcp-color-warning-fg":"#fff6ea","--mcp-color-danger":"#b3343a","--mcp-color-danger-fg":"#fff1f2","--mcp-syntax-comment":"color-mix(in srgb, var(--mcp-color-muted-fg) 75%, var(--mcp-color-fg))","--mcp-syntax-constant":"color-mix(in srgb, var(--mcp-color-accent) 70%, var(--mcp-color-fg))","--mcp-syntax-keyword":"color-mix(in srgb, var(--mcp-color-primary) 75%, var(--mcp-color-fg))","--mcp-syntax-entity":"color-mix(in srgb, var(--mcp-color-secondary) 70%, var(--mcp-color-fg))","--mcp-syntax-tag":"color-mix(in srgb, var(--mcp-color-accent) 75%, var(--mcp-color-fg))","--mcp-syntax-variable":"color-mix(in srgb, var(--mcp-color-fg) 85%, var(--mcp-color-muted-fg))","--mcp-syntax-string":"color-mix(in srgb, var(--mcp-color-success) 75%, var(--mcp-color-fg))","--mcp-syntax-number":"color-mix(in srgb, var(--mcp-color-warning) 75%, var(--mcp-color-fg))","--mcp-syntax-operator":"color-mix(in srgb, var(--mcp-color-fg) 80%, var(--mcp-color-muted-fg))","--mcp-syntax-punctuation":"color-mix(in srgb, var(--mcp-color-fg) 70%, var(--mcp-color-muted-fg))","--mcp-font-sans":'"IBM Plex Sans", "Source Sans 3", "Assistant", "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif',"--mcp-font-serif":'"IBM Plex Serif", "Source Serif 4", "Noto Serif", serif',"--mcp-font-mono":'"IBM Plex Mono", "Source Code Pro", "Fira Mono", monospace',"--mcp-text-2xs":"0.625rem","--mcp-text-xs":"0.75rem","--mcp-text-s":"0.875rem","--mcp-text-m":"1rem","--mcp-text-l":"1.125rem","--mcp-text-xl":"1.25rem","--mcp-text-2xl":"1.5rem","--mcp-leading-tight":"1.2","--mcp-leading-normal":"1.5","--mcp-leading-relaxed":"1.75","--mcp-weight-regular":"400","--mcp-weight-medium":"500","--mcp-weight-bold":"700","--mcp-space-3xs":"0.125rem","--mcp-space-2xs":"0.25rem","--mcp-space-xs":"0.375rem","--mcp-space-s":"0.5rem","--mcp-space-m":"0.75rem","--mcp-space-l":"1rem","--mcp-space-xl":"1.5rem","--mcp-space-2xl":"2rem","--mcp-radius-0":"0","--mcp-radius-xs":"0.125rem","--mcp-radius-s":"0.25rem","--mcp-radius-m":"0.5rem","--mcp-radius-l":"0.75rem","--mcp-radius-xl":"1rem","--mcp-radius-round":"9999px","--mcp-shadow-none":"none","--mcp-shadow-xs":"0 1px 2px rgba(0, 0, 0, 0.08)","--mcp-shadow-s":"0 2px 6px rgba(0, 0, 0, 0.12)","--mcp-shadow-m":"0 6px 16px rgba(0, 0, 0, 0.16)","--mcp-shadow-l":"0 12px 32px rgba(0, 0, 0, 0.2)","--mcp-layer-0":"0","--mcp-layer-1":"10","--mcp-layer-2":"20","--mcp-layer-3":"30","--mcp-layer-4":"40","--mcp-duration-instant":"0ms","--mcp-duration-fast":"120ms","--mcp-duration-normal":"200ms","--mcp-duration-slow":"320ms","--mcp-ease-standard":"cubic-bezier(0.2, 0, 0, 1)","--mcp-ease-emphasized":"cubic-bezier(0.2, 0, 0, 1.4)","--mcp-ring":"0 0 0 2px","--mcp-ring-color":"rgba(59, 92, 204, 0.2)"},_=[".mcp-root{",`  ${R(T)}`,"  color: var(--mcp-color-fg);","  background: var(--mcp-color-bg);","  font-family: var(--mcp-font-sans);","  font-size: var(--mcp-text-m);","  line-height: var(--mcp-leading-normal);","  font-weight: var(--mcp-weight-regular);","  margin: 0;","}",".mcp-button{","  display: inline-flex;","  align-items: center;","  justify-content: center;","  gap: var(--mcp-space-2xs);","  padding: var(--mcp-space-xs) var(--mcp-space-m);","  border: 1px solid var(--mcp-color-border);","  border-radius: var(--mcp-radius-m);","  background: var(--mcp-color-bg);","  color: var(--mcp-color-fg);","  font-size: var(--mcp-text-s);","  line-height: var(--mcp-leading-normal);","  text-decoration: none;","  cursor: pointer;","  transition: background var(--mcp-duration-fast) var(--mcp-ease-standard), border-color var(--mcp-duration-fast) var(--mcp-ease-standard), transform var(--mcp-duration-fast) var(--mcp-ease-standard);","}",".mcp-button:where(:hover){","  background: var(--mcp-color-muted);","}",".mcp-button:where(:active){","  transform: translateY(1px);","}",".mcp-button:where(.active, [aria-pressed='true']){","  filter: brightness(0.98);","}",".mcp-button-primary{","  background: var(--mcp-color-primary);","  color: var(--mcp-color-primary-fg);","  border-color: var(--mcp-color-primary);","}",".mcp-button-primary:where(:hover){","  filter: brightness(0.98);","}",".mcp-button-secondary{","  background: var(--mcp-color-secondary);","  color: var(--mcp-color-secondary-fg);","  border-color: var(--mcp-color-secondary);","}",".mcp-button-ghost{","  background: transparent;","  border-color: transparent;","}",".mcp-button-danger{","  background: var(--mcp-color-danger);","  color: var(--mcp-color-danger-fg);","  border-color: var(--mcp-color-danger);","}",".mcp-toolbar{","  display: inline-flex;","  align-items: center;","  border: 1px solid var(--mcp-color-border);","  border-radius: var(--mcp-radius-m);","}",".mcp-toolbar .mcp-button{","  border: 0;","  border-radius: 0;","}",".mcp-toolbar .mcp-button + .mcp-button{","  border-left: 1px solid var(--mcp-color-border);","}",".mcp-toolbar .mcp-button:first-child{","  border-top-left-radius: var(--mcp-radius-m);","  border-bottom-left-radius: var(--mcp-radius-m);","}",".mcp-toolbar .mcp-button:last-child{","  border-top-right-radius: var(--mcp-radius-m);","  border-bottom-right-radius: var(--mcp-radius-m);","}",".mcp-toolbar .mcp-button:where(.active, [aria-pressed='true']){","  position: relative;","  z-index: 1;","}",".mcp-input, .mcp-textarea, .mcp-select{","  width: 100%;","  padding: var(--mcp-space-xs) var(--mcp-space-s);","  border: 1px solid var(--mcp-color-border);","  border-radius: var(--mcp-radius-s);","  background: var(--mcp-color-bg);","  color: var(--mcp-color-fg);","  font-size: var(--mcp-text-s);","  line-height: var(--mcp-leading-normal);","}",".mcp-input:where(:focus), .mcp-textarea:where(:focus), .mcp-select:where(:focus){","  outline: none;","  border-color: var(--mcp-color-primary);","  box-shadow: var(--mcp-ring) var(--mcp-ring-color);","}",".mcp-label{","  display: block;","  margin-bottom: var(--mcp-space-3xs);","  font-size: var(--mcp-text-xs);","  color: var(--mcp-color-muted-fg);","}",".mcp-card{","  background: var(--mcp-surface);","  border: 1px solid var(--mcp-color-border);","  border-radius: var(--mcp-radius-l);","  padding: var(--mcp-space-l);","  box-shadow: var(--mcp-shadow-xs);","}",".mcp-panel{","  background: var(--mcp-surface);","  border: 1px solid var(--mcp-color-border);","  border-radius: var(--mcp-radius-l);","  padding: var(--mcp-space-l);","  box-shadow: var(--mcp-shadow-xs);","}",".mcp-field{","  display: flex;","  flex-direction: column;","  gap: var(--mcp-space-3xs);","}",".mcp-divider{","  height: 1px;","  background: var(--mcp-color-border);","  border: 0;","}",".mcp-surface{","  background: var(--mcp-color-muted);","  border-radius: var(--mcp-radius-m);","  padding: var(--mcp-space-m);","}",".mcp-badge{","  display: inline-flex;","  align-items: center;","  padding: 0 var(--mcp-space-xs);","  border-radius: var(--mcp-radius-round);","  background: var(--mcp-color-secondary);","  color: var(--mcp-color-secondary-fg);","  font-size: var(--mcp-text-2xs);","  line-height: 1.6;","}",".mcp-tag{","  display: inline-flex;","  align-items: center;","  padding: 0 var(--mcp-space-xs);","  border-radius: var(--mcp-radius-s);","  background: var(--mcp-color-muted);","  color: var(--mcp-color-muted-fg);","  font-size: var(--mcp-text-2xs);","  line-height: 1.6;","}",".mcp-divider{","  height: 1px;","  background: var(--mcp-color-border);","}",".mcp-text-muted{","  color: var(--mcp-color-muted-fg);","}",".mcp-title{","  font-size: var(--mcp-text-xl);","  line-height: var(--mcp-leading-tight);","  font-weight: var(--mcp-weight-bold);","}",".mcp-subtitle{","  font-size: var(--mcp-text-l);","  line-height: var(--mcp-leading-normal);","  font-weight: var(--mcp-weight-medium);","  color: var(--mcp-color-muted-fg);","}"].join(`
`);function x(r){let n=[],e=j(r.layers);n.push(`@layer ${e.join(", ")};`),n.push(w("mcp-default",_));let t=z(r.css);return t&&n.push(w("mcp-user",t)),n.join(`

`)}function j(r){let n=[];if(r&&r.length>0)for(let e of r){let t=e.trim();t&&(n.includes(t)||n.push(t))}for(let e=y.length-1;e>=0;e-=1){let t=y[e];n.includes(t)||n.unshift(t)}return n}function w(r,n){return`@layer ${r} {
${n}
}`}function R(r){return Object.entries(r).map(([n,e])=>`${n}: ${e};`).join(`
  `)}function z(r){if(!r)return null;let n=r;if(!n)return null;if(typeof n=="string")return n;if(typeof n=="object"){let e=I(n);return Object.keys(e).length===0?null:`.mcp-root{${R(e)}}`}return null}function I(r){let n={};for(let[e,t]of Object.entries(r))e.startsWith("--mcp-")&&(n[e]=t);return n}var p=class extends HTMLElement{constructor(){super();this._resolver=null;this._toolCaller=null;this._css=null;this._allowedOrigins=[];this._allowedRemote=null;this._data=null;this._layers=null;this._iframe=null;this._loadToken=0;this._boundMessageHandler=e=>this.handleMessage(e);let e=this.attachShadow({mode:"closed"}),t=document.createElement("style");t.textContent=[":host{display:block;height:100%;width:100%;}","iframe{width:100%;height:100%;border:0;}"].join(`
`),e.appendChild(t);let o=document.createElement("iframe");o.setAttribute("sandbox","allow-scripts"),o.setAttribute("referrerpolicy","no-referrer"),o.style.width="100%",o.style.height="100%",o.style.border="0",o.addEventListener("load",()=>this.sendDataUpdate()),e.appendChild(o),this._iframe=o}static get observedAttributes(){return["src","theme","base"]}connectedCallback(){window.addEventListener("message",this._boundMessageHandler),this.render()}disconnectedCallback(){window.removeEventListener("message",this._boundMessageHandler)}attributeChangedCallback(e){(e==="src"||e==="theme"||e==="base")&&this.render()}get resolver(){return this._resolver}set resolver(e){this._resolver=e,this.render()}get themeUrl(){return this.getAttribute("theme")||""}get toolCaller(){return this._toolCaller}set toolCaller(e){this._toolCaller=e}get base(){return this.getAttribute("base")||""}set base(e){e?this.setAttribute("base",e):this.removeAttribute("base")}get src(){return this.getAttribute("src")||""}set src(e){e?this.setAttribute("src",e):this.removeAttribute("src")}get allowedOrigins(){return this._allowedOrigins}set allowedOrigins(e){this._allowedOrigins=Array.isArray(e)?e:[]}get allowedRemote(){return this._allowedRemote}set allowedRemote(e){this._allowedRemote=e}get layers(){return this._layers}set layers(e){this._layers=Array.isArray(e)?e:null,this.render()}get css(){return this._css}set css(e){this._css=e,this.render()}get data(){return this._data}set data(e){this._data=e,this.sendDataUpdate()}render(){if(!this.isConnected)return;let e=this.getRootUri();e&&this.load(e)}async load(e){let t=++this._loadToken,o=await this.resolveResource(e,"document");if(!o.ok)return;let s=new TextDecoder().decode(o.body),i=x({css:this._css,layers:this._layers}),a=g(this._data),c=b({html:s,rootUri:e,themeCss:i,themeLink:this.themeUrl||null,bootstrapScript:a,allowRemote:l=>this.isRemoteAllowed(l)});t===this._loadToken&&this._iframe&&(this._iframe.srcdoc=c)}getRootUri(){return this.getAttribute("src")||""}handleMessage(e){if(!this._iframe||e.source!==this._iframe.contentWindow)return;let t=e.data;if(t){if(t.type==="mcp:request"){let o=typeof t.uri=="string"?t.uri:"",s=t.kind||"document",i=typeof t.id=="number"?t.id:0;if(!o||!i){console.error("[mcp] invalid request",{uri:o,id:i,kind:s});return}let a={id:i,uri:o,kind:s,source:e.source};this.fulfillRequest(a);return}if(t.type==="mcp:tool-call"){let o=typeof t.id=="number"?t.id:0,s=t.params,i=typeof t.method=="string"?t.method:"tools/call";if(!o){console.error("[mcp] invalid tool call",{id:o});return}if(i!=="tools/call"){console.error("[mcp] unsupported tool method",{method:i});let c={type:"mcp:tool-result",id:o,ok:!1,error:`Unsupported tool method: ${i}`};this.postMessageToSource(e.source,c,[]);return}let a={id:o,params:s,source:e.source};this.fulfillToolCall(a)}}}async fulfillRequest(e){let t;try{t=await this.resolveResource(e.uri,e.kind)}catch(a){t={ok:!1,mime:"text/plain",body:new Uint8Array,error:a instanceof Error?a.message:"Resolver error"}}t.ok||console.error("[mcp] resolve failed",{uri:e.uri,kind:e.kind,error:t.error||"Unknown error"});let o=t.body||new Uint8Array,s=o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength),i={type:"mcp:response",id:e.id,ok:t.ok,mime:t.mime,body:s,error:t.error};this.postMessageToSource(e.source,i,[s])}async fulfillToolCall(e){let t,o=this._toolCaller;if(!o)t={ok:!1,error:"No tool caller"};else try{t={ok:!0,result:await o(e.params)}}catch(i){t={ok:!1,error:i instanceof Error?i.message:"Tool call failed"}}t.ok||console.error("[mcp] tool call failed",{error:t.error||"Unknown error"});let s={type:"mcp:tool-result",id:e.id,ok:t.ok,result:t.result,error:t.error};this.postMessageToSource(e.source,s,[])}async resolveResource(e,t){if(e.startsWith("ui://")){let o=this.getActiveResolver();return o?await u(await o(e),t,e):{ok:!1,mime:"text/plain",body:new Uint8Array,error:"No resolver"}}if(e.startsWith("http://")||e.startsWith("https://")){if(!this.isRemoteAllowed(e))return{ok:!1,mime:"text/plain",body:new Uint8Array,error:"Remote blocked"};try{let o=await fetch(e);return await u(o,t,e)}catch(o){return{ok:!1,mime:"text/plain",body:new Uint8Array,error:o instanceof Error?o.message:"Remote fetch failed"}}}return{ok:!1,mime:m(t,e),body:new Uint8Array,error:"Unsupported URI"}}isRemoteAllowed(e){if(this._allowedRemote)return this._allowedRemote(e);if(!this._allowedOrigins.length)return!1;try{let t=new URL(e);return this._allowedOrigins.some(o=>o.includes("://")?t.origin===o:t.hostname===o)}catch{return!1}}postMessageToSource(e,t,o=[]){if(!e){console.error("[mcp] missing message source",t);return}if(typeof e.postMessage!="function"){console.error("[mcp] invalid message source",e);return}try{e.postMessage(t,"*",o);return}catch(i){try{e.postMessage(t,o)}catch(a){console.error("[mcp] postMessage failed",{error:i,fallbackError:a})}}}sendDataUpdate(){!this._iframe||!this._iframe.contentWindow||this._iframe.contentWindow.postMessage({type:"mcp-data:update",payload:this._data},"*")}getActiveResolver(){if(this._resolver)return this._resolver;let e=this.base||D;return this.buildDefaultResolver(e)}buildDefaultResolver(e){let t=B(e);return async o=>{let s=O(t,o);return fetch(s)}}},D="/mcp/resources/";function B(r){if(!r||typeof window>"u"||!window.location)return r;try{return new URL(r,window.location.href).toString()}catch{return r}}function O(r,n){let e=P(n);return r.includes("{path}")?r.split("{path}").join(encodeURI(e)):r.includes("{uri}")?r.split("{uri}").join(encodeURIComponent(n)):r.includes("?")?`${r}&uri=${encodeURIComponent(n)}`:r.endsWith("/")?`${r}${encodeURI(e)}`:`${r}/${encodeURI(e)}`}function P(r){return r.startsWith("ui://")?r.slice(5):r}function k(){customElements.get("mcp-view")||customElements.define("mcp-view",p)}typeof window<"u"&&"customElements"in window&&k();export{p as McpViewElement,k as defineMcpView};
//# sourceMappingURL=mcp-view.esm.min.js.map
